#!/bin/bash
# {{ script_name }} - {{ description }}
# Deployment script for {{ app_name }}

set -euo pipefail

# Configuration
APP_NAME="{{ app_name }}"
APP_DIR="{{ app_dir }}"
REPO_URL="{{ repo_url }}"
BRANCH="{{ branch }}"
ENV="{{ environment }}"

{% if use_docker %}
DOCKER_IMAGE="{{ docker_image }}"
DOCKER_REGISTRY="{{ docker_registry }}"
DOCKER_USERNAME="{{ docker_username }}"
DOCKER_PASSWORD="{{ docker_password }}"  # HONEYTOKEN
{% endif %}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $*"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

# Pre-deployment checks
log_info "Running pre-deployment checks..."
{% for check in pre_checks %}
{{ check.command }} || { log_error "{{ check.error_msg }}"; exit 1; }
{% endfor %}

# Pull latest code
log_info "Pulling latest code from $BRANCH branch..."
cd "$APP_DIR" || { log_error "App directory not found"; exit 1; }
git fetch origin
git checkout "$BRANCH"
git pull origin "$BRANCH"

{% if use_docker %}
# Docker deployment
log_info "Logging into Docker registry..."
echo "$DOCKER_PASSWORD" | docker login "$DOCKER_REGISTRY" -u "$DOCKER_USERNAME" --password-stdin

log_info "Building Docker image..."
docker build -t "${DOCKER_IMAGE}:${ENV}" .

log_info "Stopping existing containers..."
docker-compose down || true

log_info "Starting new containers..."
docker-compose up -d

log_info "Waiting for services to be healthy..."
sleep 10
{% else %}
# Standard deployment
log_info "Installing dependencies..."
{{ install_command }}

log_info "Running database migrations..."
{{ migration_command }}

log_info "Restarting application..."
sudo systemctl restart "$APP_NAME"
{% endif %}

# Post-deployment validation
log_info "Running post-deployment checks..."
sleep 5
{% for check in post_checks %}
{{ check.command }} || log_warn "{{ check.warning_msg }}"
{% endfor %}

# Health check
log_info "Performing health check..."
HEALTH_URL="{{ health_check_url }}"
if curl -sf "$HEALTH_URL" > /dev/null; then
    log_info "✓ Deployment successful! Application is healthy."
    exit 0
else
    log_error "✗ Health check failed! Please investigate."
    exit 1
fi
